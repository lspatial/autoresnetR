tlocDt=read.csv(adtFl,row.names = NULL,sep="'| +")
tlocDt=read.csv(adtFl,row.names = NULL,sep="'| ")
rpath="/mnt/pmdata2_dup2/LEO/caaot/weeklyResAutoRes/aeronet"
adtFl=paste(rpath,"/aeronet_Goldstone.csv",sep="")
tlocDt=readLines(adtFl)
rpath="/mnt/pmdata2_dup2/LEO/caaot/weeklyResAutoRes/aeronet"
adtFl=paste(rpath,"/aeronet_Goldstone.csv",sep="")
aerolines=readLines(adtFl)
strsplit(aerolines[1],"'")
aerolines[1]
str(aerolines)
tcols=read.csv(aerolines[1])
tcols=read.csv(text=aerolines[1])
tcols
aerolines[2:]
aesiteDt=read.table(text=aerolines[2:length(aerolines)],sep="",
col.names = tcols)
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],sep=" ",
col.names = tcols)
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],sep=" +",
col.names = tcols)
tcols
tcols=colnames(read.csv(text=aerolines[1]))
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],sep=" +",
col.names = tcols)
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],sep=" ",
col.names = tcols)
rpath="/mnt/pmdata2_dup2/LEO/caaot/weeklyResAutoRes/aeronet"
adtFl=paste(rpath,"/aeronet_Goldstone.csv",sep="")
aerolines=readLines(adtFl)
tcols=colnames(read.csv(text=aerolines[1]))
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],sep=" ",
col.names = tcols)
tcols
str(aerolines)
aerolines[2]
strsplit(aerolines[2]," ")
?read.table
rpath="/mnt/pmdata2_dup2/LEO/caaot/weeklyResAutoRes/aeronet"
adtFl=paste(rpath,"/aeronet_Goldstone.csv",sep="")
aerolines=readLines(adtFl)
tcols=colnames(read.csv(text=aerolines[1]))
aesiteDt=read.table(text=aerolines[c(2:length(aerolines))],
col.names = tcols)
aerolines[c(2:length(aerolines))]
aesiteDt=read.table(text=aerolines[2],
col.names = tcols)
tcols
aerolines[2]
tcols
firstline=strsplit(aerolines[2], "\\s+")[[1]]
firstline
tcols
tcols
tmpline="Date(dd:mm:yyyy),Time(hh:mm:ss),Day_of_Year,Day_of_Year(Fraction),AOD_1640nm,AOD_1020nm,AOD_870nm,AOD_865nm,AOD_779nm,AOD_675nm,AOD_667nm,AOD_620nm,AOD_560nm,AOD_555nm,AOD_551nm,AOD_532nm,AOD_531nm,AOD_510nm,AOD_500nm,AOD_490nm,AOD_443nm,AOD_440nm,AOD_412nm,AOD_400nm,AOD_380nm,AOD_340nm,Precipitable_Water(cm),AOD_681nm,AOD_709nm,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,Triplet_Variability_1640,Triplet_Variability_1020,Triplet_Variability_870,Triplet_Variability_865,Triplet_Variability_779,Triplet_Variability_675,Triplet_Variability_667,Triplet_Variability_620,Triplet_Variability_560,Triplet_Variability_555,Triplet_Variability_551,Triplet_Variability_532,Triplet_Variability_531,Triplet_Variability_510,Triplet_Variability_500,Triplet_Variability_490,Triplet_Variability_443,Triplet_Variability_440,Triplet_Variability_412,Triplet_Variability_400,Triplet_Variability_380,Triplet_Variability_340,Triplet_Variability_Precipitable_Water(cm),Triplet_Variability_681,Triplet_Variability_709,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,440-870_Angstrom_Exponent,380-500_Angstrom_Exponent,440-675_Angstrom_Exponent,500-870_Angstrom_Exponent,340-440_Angstrom_Exponent,440-675_Angstrom_Exponent[Polar],Data_Quality_Level,AERONET_Instrument_Number,AERONET_Site_Name,Site_Latitude(Degrees),Site_Longitude(Degrees),Site_Elevation(m),Solar_Zenith_Angle(Degrees),Optical_Air_Mass,Sensor_Temperature(Degrees_C),Ozone(Dobson),NO2(Dobson),Last_Date_Processed,Number_of_Wavelengths,Exact_Wavelengths_of_AOD(um)_1640nm,Exact_Wavelengths_of_AOD(um)_1020nm,Exact_Wavelengths_of_AOD(um)_870nm,Exact_Wavelengths_of_AOD(um)_865nm,Exact_Wavelengths_of_AOD(um)_779nm,Exact_Wavelengths_of_AOD(um)_675nm,Exact_Wavelengths_of_AOD(um)_667nm,Exact_Wavelengths_of_AOD(um)_620nm,Exact_Wavelengths_of_AOD(um)_560nm,Exact_Wavelengths_of_AOD(um)_555nm,Exact_Wavelengths_of_AOD(um)_551nm,Exact_Wavelengths_of_AOD(um)_532nm,Exact_Wavelengths_of_AOD(um)_531nm,Exact_Wavelengths_of_AOD(um)_510nm,Exact_Wavelengths_of_AOD(um)_500nm,Exact_Wavelengths_of_AOD(um)_490nm,Exact_Wavelengths_of_AOD(um)_443nm,Exact_Wavelengths_of_AOD(um)_440nm,Exact_Wavelengths_of_AOD(um)_412nm,Exact_Wavelengths_of_AOD(um)_400nm,Exact_Wavelengths_of_AOD(um)_380nm,Exact_Wavelengths_of_AOD(um)_340nm,Exact_Wavelengths_of_PW(um)_935nm,Exact_Wavelengths_of_AOD(um)_681nm,Exact_Wavelengths_of_AOD(um)_709nm,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty"
firstline=strsplit(tmpline, "\\s+")[[1]]
firstline
tmpline="Date(dd:mm:yyyy),Time(hh:mm:ss),Day_of_Year,Day_of_Year(Fraction),AOD_1640nm,AOD_1020nm,AOD_870nm,AOD_865nm,AOD_779nm,AOD_675nm,AOD_667nm,AOD_620nm,AOD_560nm,AOD_555nm,AOD_551nm,AOD_532nm,AOD_531nm,AOD_510nm,AOD_500nm,AOD_490nm,AOD_443nm,AOD_440nm,AOD_412nm,AOD_400nm,AOD_380nm,AOD_340nm,Precipitable_Water(cm),AOD_681nm,AOD_709nm,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,Triplet_Variability_1640,Triplet_Variability_1020,Triplet_Variability_870,Triplet_Variability_865,Triplet_Variability_779,Triplet_Variability_675,Triplet_Variability_667,Triplet_Variability_620,Triplet_Variability_560,Triplet_Variability_555,Triplet_Variability_551,Triplet_Variability_532,Triplet_Variability_531,Triplet_Variability_510,Triplet_Variability_500,Triplet_Variability_490,Triplet_Variability_443,Triplet_Variability_440,Triplet_Variability_412,Triplet_Variability_400,Triplet_Variability_380,Triplet_Variability_340,Triplet_Variability_Precipitable_Water(cm),Triplet_Variability_681,Triplet_Variability_709,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,440-870_Angstrom_Exponent,380-500_Angstrom_Exponent,440-675_Angstrom_Exponent,500-870_Angstrom_Exponent,340-440_Angstrom_Exponent,440-675_Angstrom_Exponent[Polar],Data_Quality_Level,AERONET_Instrument_Number,AERONET_Site_Name,Site_Latitude(Degrees),Site_Longitude(Degrees),Site_Elevation(m),Solar_Zenith_Angle(Degrees),Optical_Air_Mass,Sensor_Temperature(Degrees_C),Ozone(Dobson),NO2(Dobson),Last_Date_Processed,Number_of_Wavelengths,Exact_Wavelengths_of_AOD(um)_1640nm,Exact_Wavelengths_of_AOD(um)_1020nm,Exact_Wavelengths_of_AOD(um)_870nm,Exact_Wavelengths_of_AOD(um)_865nm,Exact_Wavelengths_of_AOD(um)_779nm,Exact_Wavelengths_of_AOD(um)_675nm,Exact_Wavelengths_of_AOD(um)_667nm,Exact_Wavelengths_of_AOD(um)_620nm,Exact_Wavelengths_of_AOD(um)_560nm,Exact_Wavelengths_of_AOD(um)_555nm,Exact_Wavelengths_of_AOD(um)_551nm,Exact_Wavelengths_of_AOD(um)_532nm,Exact_Wavelengths_of_AOD(um)_531nm,Exact_Wavelengths_of_AOD(um)_510nm,Exact_Wavelengths_of_AOD(um)_500nm,Exact_Wavelengths_of_AOD(um)_490nm,Exact_Wavelengths_of_AOD(um)_443nm,Exact_Wavelengths_of_AOD(um)_440nm,Exact_Wavelengths_of_AOD(um)_412nm,Exact_Wavelengths_of_AOD(um)_400nm,Exact_Wavelengths_of_AOD(um)_380nm,Exact_Wavelengths_of_AOD(um)_340nm,Exact_Wavelengths_of_PW(um)_935nm,Exact_Wavelengths_of_AOD(um)_681nm,Exact_Wavelengths_of_AOD(um)_709nm,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty,Exact_Wavelengths_of_AOD(um)_Empty"
firstline=strsplit(tmpline, "\\,+")[[1]]
firstline
aline="AERONET_Site,Date(dd-mm-yyyy),Time(hh:mm:ss),Day_of_Year,Day_of_Year(Fraction),AOD_1640nm,AOD_1020nm,AOD_870nm,AOD_865nm,AOD_779nm,AOD_675nm,AOD_667nm,AOD_620nm,AOD_560nm,AOD_555nm,AOD_551nm,AOD_532nm,AOD_531nm,AOD_510nm,AOD_500nm,AOD_490nm,AOD_443nm,AOD_440nm,AOD_412nm,AOD_400nm,AOD_380nm,AOD_340nm,Precipitable_Water(cm),AOD_681nm,AOD_709nm,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,AOD_Empty,Triplet_Variability_1640,Triplet_Variability_1020,Triplet_Variability_870,Triplet_Variability_865,Triplet_Variability_779,Triplet_Variability_675,Triplet_Variability_667,Triplet_Variability_620,Triplet_Variability_560,Triplet_Variability_555,Triplet_Variability_551,Triplet_Variability_532,Triplet_Variability_531,Triplet_Variability_510,Triplet_Variability_500,Triplet_Variability_490,Triplet_Variability_443,Triplet_Variability_440,Triplet_Variability_412,Triplet_Variability_400,Triplet_Variability_380,Triplet_Variability_340,Triplet_Variability_Precipitable_Water(cm),Triplet_Variability_681,Triplet_Variability_709,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,Triplet_Variability_AOD_Empty,440-870_Angstrom_Exponent,380-500_Angstrom_Exponent,440-675_Angstrom_Exponent,500-870_Angstrom_Exponent,340-440_Angstrom_Exponent,440-675_Angstrom_Exponent[Polar],Data_Quality_Level,AERONET_Instrument_Number,AERONET_Site_Name,Site_Latitude(Degrees),Site_Longitude(Degrees),Site_Elevation(m),Solar_Zenith_Angle(Degrees),Optical_Air_Mass,Sensor_Temperature(Degrees_C),Ozone(Dobson),NO2(Dobson),Last_Date_Processed,Number_of_Wavelengths,Exact_Wavelengths_of_AOD(um)"
tcols=read.csv(text=aline,row.names = NULL)
tcols
dval='"Goldstone" "16:12:2009" "15:43:38" 350 350.655301 0.034838 -999 0.041584 -999 -999 0.048988 -999 -999 -999 -999 -999 -999 -999 -999 0.071188 -999 -999 0.086912 -999 -999 0.114905 0.142795 0.698396 -999 -999 -999 -999 -999 -999 -999 0.004347 -999 0.003726 -999 -999 0.00402 -999 -999 -999 -999 -999 -999 -999 -999 0.003403 -999 -999 0.003335 -999 -999 0.003228 0.002775 0.013592 -999 -999 -999 -999 -999 -999 -999 1.084301 1.775348 1.306131 0.979792 1.98458 -999 "lev20" 604 "Goldstone" 35.233333 -116.791667 1100 81.363038 6.394575 13.9 0.282205 0.14184 "07:12:2017" 7 1.6392 0.869 0.676 0.4995 0.438 0.3813 0.341'
dval=read.table(text=dval,row.names = NULL)
dval
install.packages("elevatr")
install.packages("sf")
library(raster)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_rnet_downscale"
aimgpath=paste(rpath,"/down156.tif",sep="")
aimg=raster(aimgpath)
aimg
library(raster)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_rnet_downscale"
aimgpath=paste(rpath,"/down94.tif",sep="")
aimg=stack(aimgpath)
aimg
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_rnet_downscale"
aimgpath=paste(rpath,"/down94.tif",sep="")
astk=stack(aimgpath)
names(astk)=c("mintmp","maxtmp","wspd","sph","srad","aod","merra2","ele","xx","yy",
"maot","yaot","laod_mean", "aodl10_gmi","aodl14_gmi","pr")
astk
?raster
elelayer=raster(astk,layer=8)
range(values(elelayer))
elelayer=raster(astk,layer=8)
range(values(elelayer),na.rm = TRUE)
plot(elelayer)
library(rgdal)
ca_border=readOGR(dsn="/mnt/pmdata/ECHO_PMmodels/camap",layer="ca_border_sin")
plot(ca_border,add=TRUE)
?extract
avail_ele=extract(elelayer, ca_border)
sptsEle=rasterToPoints(elelayer, spatial = TRUE)
sptsEle
?gIntersects
library(rgeos)
?gIntersects
Results=gIntersects(sptsEle,ca_border,byid=TRUE)
Results
resIndex=gIntersects(sptsEle,ca_border,byid=TRUE)
sptsEle=sptsEle[resIndex,]
sptsEle=rasterToPoints(elelayer, spatial = TRUE)
resIndex=gIntersects(sptsEle,ca_border,byid=TRUE)
sptsEleCA=sptsEle[resIndex,]
str(resIndex)
resIndex
sptsEleCA=sptsEle[which(resIndex),]
nrow(sptsEle);nrow(sptsEleCA)
sptsEleCA
sptsEleCANULL=sptsEleCA[which(is.na(sptsEleCA)),]
sptsEleCANULL=sptsEleCA[which(is.na(values(sptsEleCA))),]
sptsEleCANULL=sptsEleCA[which(is.na(sptsEleCA@data$ele)),]
sptsEleCANULL
elelayer=raster(astk,layer=8)
range(values(elelayer),na.rm = TRUE)
plot(elelayer)
library(rgdal)
ca_border=readOGR(dsn="/mnt/pmdata/ECHO_PMmodels/camap",layer="ca_border_sin")
plot(ca_border,add=TRUE)
sptsEle=rasterToPoints(elelayer, spatial = TRUE)
elelayer
?rasterToPoints
resIndex=gIntersects(elelayer,ca_border,byid=TRUE)
elelayerCA=mask(elelayer, ca_border)
ca_border
elelayerCA
plot(elelayerCA)
elelayerCA=intersect(elelayer,ca_border)
elelayerCA
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
sptsEle
templayer=raster(astk,layer=1)
?overlay
alayer=overlay(elelayer,templayer,fun=function(x,y){
if(is.na(x)){
-9999
}else{
x
}
} )
elelayerM=overlay(elelayer,templayer,fun=function(x,y){
if(is.na(x)){
return(-9999)
}else{
return(x)
}
}
)
fun = function(x) { x[is.na(x)] =-9999; return(x) }
elelayerM = calc(elelayer, fun)
elelayerCA=mask(elelayerM, ca_border)
plot(elelayerCA)
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
sptsEleCANULL=sptsEleCA[which(sptsEleCA@data$ele==-9999),]
sptsEleCANULL
plot(elelayerCA)
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
elelayerCA
sptsEle
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
names(sptsEle)=c("ele")
sptsEle
sptsEleCANULL=sptsEleCA[which(sptsEleCA@data$ele==-9999),]
sptsEleCANULL
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
names(sptsEle)=c("ele")
sptsEleMissed=sptsEle[which(sptsEle@data$ele==-9999),]
sptsEleMissed
library(rgbif)
sptsEleMissed
coordinates(spTransform(sptsEle, CRS("+proj=longlat +datum=WGS84")))
coordinates(spTransform(sptsEleMissed, CRS("+proj=longlat +datum=WGS84")))
coods=coordinates(spTransform(sptsEleMissed, CRS("+proj=longlat +datum=WGS84")))
str(coods)
library(rgbif)
elevation
coods=coordinates(spTransform(sptsEleMissed, CRS("+proj=longlat +datum=WGS84")))
coods[,1]
coods[,2]
eles=elevation(latitude=coods[,1], longitude=coods[,2],
key ="AIzaSyBmPMLKTkbWUvan94kt3wAeCiY4JVPJjfk")
eles=elevation(latitude=coods[,2], longitude=coods[,1],
key ="AIzaSyBmPMLKTkbWUvan94kt3wAeCiY4JVPJjfk")
eles
index=which(sptsEle@data$ele==-9999)
sptsEleMissed=sptsEle[index,]
coods=coordinates(spTransform(sptsEleMissed, CRS("+proj=longlat +datum=WGS84")))
# Pass in a vector of lat's and a vector of long's
eles=elevation(latitude=coods[,2], longitude=coods[,1],
key ="AIzaSyBmPMLKTkbWUvan94kt3wAeCiY4JVPJjfk")
sptsEle[index,"ele"]=eles$elevation
range(sptsEle[index,"ele"])
eles$elevation
sptsEle[index,"ele"]
sptsEle@data[index,"ele"]
sptsEle@data[index,"ele"]=eles$elevation
range(sptsEle[index,"ele"])
range(sptsEle@data[index,"ele"])
range(sptsEle@data[,"ele"])
?rasterFromCells
elelayerCAFull=rasterFromCells(sptsEle)
elelayerCAFull=rasterFromXYZ(sptsEle)
elelayerCAFull
elelayer
elelayerCAFull
elelayerCA
proj4string(elelayerCA)
proj4string(elelayerCAFull)=proj4string(elelayerCA)
proj4string(elelayerCAFull)=proj4string(elelayerCA)
plot(elelayerCAFull)
plot(ca_border,add=TRUE)
library(raster)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_rnet_downscale"
aimgpath=paste(rpath,"/down94.tif",sep="")
astk=stack(aimgpath)
names(astk)=c("mintmp","maxtmp","wspd","sph","srad","aod","merra2","ele","xx","yy",
"maot","yaot","laod_mean", "aodl10_gmi","aodl14_gmi","pr")
elelayer=raster(astk,layer=8)
range(values(elelayer),na.rm = TRUE)
plot(elelayer)
library(rgdal)
ca_border=readOGR(dsn="/mnt/pmdata/ECHO_PMmodels/camap",layer="ca_border_sin")
plot(ca_border,add=TRUE)
templayer=raster(astk,layer=1)
fun = function(x) { x[is.na(x)] =-9999; return(x) }
elelayerM = calc(elelayer, fun)
elelayerCA=mask(elelayerM, ca_border)
plot(elelayerCA)
sptsEle=rasterToPoints(elelayerCA, spatial = TRUE)
names(sptsEle)=c("ele")
index=which(sptsEle@data$ele==-9999)
sptsEleMissed=sptsEle[index,]
coods=coordinates(spTransform(sptsEleMissed, CRS("+proj=longlat +datum=WGS84")))
library(rgbif)
# Pass in a vector of lat's and a vector of long's
eles=elevation(latitude=coods[,2], longitude=coods[,1],
key ="AIzaSyBmPMLKTkbWUvan94kt3wAeCiY4JVPJjfk")
eles$elevation
sptsEle@data[index,"ele"]=eles$elevation
range(sptsEle@data[,"ele"])
elelayerCAFull=rasterFromXYZ(sptsEle)
proj4string(elelayerCAFull)=proj4string(elelayerCA)
plot(elelayerCAFull)
plot(ca_border,add=TRUE)
plot(elelayerCAFull)
plot(ca_border,add=TRUE)
?writeRaster
writeRaster(elelayerCAFull,filename="/home/lianfal/aodprj/covs_supp/caele",
format="GTiff", overwrite=TRUE)
elelayerCAFull
12*16
12*17
den=34
class(den)
den/29.0
for(yr in seq(2000,2016)){
mts=data.frame(year=yr,mid=c(1:12))
tPath=paste("/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/",yr,sep="")
if(!dir.exists(tPath)){
dir.create(tPath)
}
if(yr==2000){
allmts=mts
}else{
allmts=rbind(allmts,mts)
}
}
saveRDS(allmts,file="/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/allmts.rds")
allmts=readRDS("/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/allmts.rds")
#print(alldts)
for(yr in seq(2000,2016)){
yts=data.frame(year=yr)
if(yr==2000){
allyts=yts
}else{
allyts=rbind(allyts,yts)
}
}
tfl="/mnt/pmdata/ECHO_PMmodels/caaot/yearaotup/allyts.rds"
saveRDS(allyts,tfl)
#############Monthly AOD
tpath="/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/2000/mMonth_2000-02.tif"
rst=raster(tpath)
plot(rst)
tpath="/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/2000/mMonth_2000-08.tif"
rst=raster(tpath)
plot(rst)
tpath="/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/2000/mMonth_2000-09.tif"
rst=raster(tpath)
plot(rst)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
fls=list.dirs(rpath)
fls
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
fls=list.files(rpath)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
fls
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
fls=list.files(rpath)
fls=fls[grep("^wk[0-9]{1,9}aod$\\.tif",fls)]
fls
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
fls=list.files(rpath)
fls=fls[grep("^wk[0-9]{1,9}aod\\.tif$",fls)]
fls
imgsDf=data.frame(fl=fls,stringsAsFactors = FALSE)
gsub("wk|aod\\.tif","","wk876aod.tif")
gsub("wk|aod\\.tif","",imgsDf$fl)
integer(gsub("wk|aod\\.tif","",imgsDf$fl))
imgsDf$weekid=as.integer(gsub("wk|aod\\.tif","",imgsDf$fl))
imgsDf
imgsDf$start_date=as.Date(origin=as.Date("2000-02-28"),x=(imgsDf$weekid-1)*7)
imgsDf$end_date=as.Date(origin=as.Date("2000-02-28"),x=imgsDf$weekid*7-1)
imgsDf
format(imgsDf$start_date,"%Y")
format(imgsDf$start_date,"%m")
imgsDf$year=as.integer(format(imgsDf$start_date,"%Y"))
imgsDf$month=as.integer(format(imgsDf$start_date,"%m"))
imgsDf
imgsDf$start_date=as.Date(origin=as.Date("2000-02-28"),x=(imgsDf$weekid-1)*7)
imgsDf$mid_date=as.Date(origin=as.Date("2000-02-28"),x=(imgsDf$weekid-1)*3)
imgsDf$end_date=as.Date(origin=as.Date("2000-02-28"),x=imgsDf$weekid*7-1)
imgsDf$year=as.integer(format(imgsDf$mid_date,"%Y"))
imgsDf$month=as.integer(format(imgsDf$mid_date,"%m"))
imgsDf
saveRDS(imgsDf,file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds")
file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds"
imgsDf=readRDS(file)
imgsDf=imgsDf[order(imgsDf$weekid),]
saveRDS(imgsDf,file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds")
################
file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds"
imgsDf=readRDS(file)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
imgindex=3
aimgDf=imgsDf[imgindex,]
aimgDf
orgFl=paste(rpath,"/",aimgDf$fl,sep="")
orgFl
orgStk=stack(orgFl)
orgStk
names(orgStk)=c("mintmp","maxtmp","wspd","sph","srad","aod","merra2","ele","xx","yy",
"maot","yaot","laod_mean", "aodl10_gmi","aodl14_gmi","pr")
orgStk
names(orgStk)
eleRast=raster(filename="/home/lianfal/aodprj/covs_supp/caele")
eleRast=raster(file="/home/lianfal/aodprj/covs_supp/caele")
?raster
eleRast=raster(file="/home/lianfal/aodprj/covs_supp/caele.tif")
eleRast=raster(x="/home/lianfal/aodprj/covs_supp/caele.tif")
plot(eleRast)
replaceBandImg=function(astack,layerindex,layername,replaceRst){
if(layerindex==1){
resStk=stack(replaceRst,subset(astack,c(2:nlayers(astack))))
}else if(layerindex==nlayers(astack)){
resStk=stack(subset(astack,c(1:(nlayers(astack)-1))),replaceRst)
}else{
resStk=stack(subset(astack,c(1:(layerindex-1))),replaceRst,subset(astack,c((layerindex+1):nlayers(astack))))
}
names(resStk)[layerindex]=layername
rm(list=c("astack","replaceRst"))
gc()
return(resStk)
}
replaceBandImg=function(astack,layerindex,layername,replaceRst){
if(layerindex==1){
resStk=stack(replaceRst,subset(astack,c(2:nlayers(astack))))
}else if(layerindex==nlayers(astack)){
resStk=stack(subset(astack,c(1:(nlayers(astack)-1))),replaceRst)
}else{
resStk=stack(subset(astack,c(1:(layerindex-1))),replaceRst,subset(astack,c((layerindex+1):nlayers(astack))))
}
names(resStk)[layerindex]=layername
rm(list=c("astack","replaceRst"))
gc()
return(resStk)
}
file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds"
imgsDf=readRDS(file)
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
imgindex=3
aimgDf=imgsDf[imgindex,]
orgFl=paste(rpath,"/",aimgDf$fl,sep="")
orgStk=stack(orgFl)
names(orgStk)=c("mintmp","maxtmp","wspd","sph","srad","aod","merra2","ele","xx","yy",
"maot","yaot","laod_mean", "aodl10_gmi","aodl14_gmi","pr")
eleRast=raster(x="/home/lianfal/aodprj/covs_supp/caele.tif")
plot(eleRast)
eleStk=replaceBandImg(orgStk,8,"ele",eleRast)
eleStk
orgStk
par(mfrow=c(1,2),mar=c(1,1,1,1))
plot(raster(orgStk,8))
plot(raster(eleStk,8))
monthAODFl=paste("/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/",aimgDf$year,
"/mMonth_",aimgDf$year,"-",ifelse(aimgDf$month<10,"0",""),aimgDf$month,".tif",sep="")
monthAODFl
monthaodRst=raster(monthAODFl)
monthaodRst
plot(monthaodRst)
eleStk=replaceBandImg(eleStk,11,"maot",monthaodRst)
monthaodRst
eleStk
monthaodRst2=crop(monthaodRst, eleRast)
monthaodRst2
eleStk
monthaodRst2=crop(monthaodRst, eleRast)
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
monthaodRst2
eleStk
monthaodRst2=crop(monthaodRst, eleStk)
monthaodRst2
eleStk
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
monthaodRst2=extend(monthaodRst, eleStk)
monthaodRst2
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
?resample
monthaodRst2=resample(monthaodRst,eleStk)
plot(monthaodRst2)
plot(monthaodRst)
plot(monthaodRst2)
plot(monthaodRst)
plot(ca_border,add=TRUE)
plot(monthaodRst2)
plot(ca_border,add=TRUE)
monthaodRst2=resample(monthaodRst,eleStk)
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
maodeleStk
plot(raster(maodeleStk,layer=11))
plot(ca_border,add=TRUE)
ca_border=readOGR(dsn="/mnt/pmdata/ECHO_PMmodels/camap",layer="ca_border_sin")
monthaodRst2=mask(monthaodRst2,ca_border)
plot(monthaodRst2)
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
plot(raster(maodeleStk,layer=11))
yearlyAODFl=paste("/mnt/pmdata/ECHO_PMmodels/caaot/yearaot/aod",aimgDf$year,".tif",sep="")
yearaodRst=raster(yearlyAODFl)
# plot(monthaodRst)
yearaodRst2=resample(yearaodRst,eleStk)
yearaodRst2=mask(yearaodRst2,ca_border)
ymaodeleStk=replaceBandImg(eleStk,11,"maot",yearaodRst2)
yearlyAODFl=paste("/mnt/pmdata/ECHO_PMmodels/caaot/yearaot/aod",aimgDf$year,".tif",sep="")
yearaodRst=raster(yearlyAODFl)
# plot(monthaodRst)
yearaodRst2=resample(yearaodRst,eleStk)
yearaodRst2=mask(yearaodRst2,ca_border)
ymaodeleStk=replaceBandImg(eleStk,12,"maot",yearaodRst2)
imgsDf
tfile=paste("/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/wk",aimgDf$weekid,"aod.tif",sep="")
tfile=paste("/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/wk",aimgDf$weekid,"aod",sep="")
writeRaster(ymaodeleStk,tfile,format="GTiff", overwrite=TRUE)
library(rgdal)
library(sp)
library(raster)
replaceBandImg=function(astack,layerindex,layername,replaceRst){
if(layerindex==1){
resStk=stack(replaceRst,subset(astack,c(2:nlayers(astack))))
}else if(layerindex==nlayers(astack)){
resStk=stack(subset(astack,c(1:(nlayers(astack)-1))),replaceRst)
}else{
resStk=stack(subset(astack,c(1:(layerindex-1))),replaceRst,subset(astack,c((layerindex+1):nlayers(astack))))
}
names(resStk)[layerindex]=layername
rm(list=c("astack","replaceRst"))
gc()
return(resStk)
}
file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds"
imgsDf=readRDS(file)
updateAWeek=function(imgindex,imgsDf=imgsDf){
# imgindex=3  ;
rpath="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst"
aimgDf=imgsDf[imgindex,]
ca_border=readOGR(dsn="/mnt/pmdata/ECHO_PMmodels/camap",layer="ca_border_sin")
# Elevation
orgFl=paste(rpath,"/",aimgDf$fl,sep="")
orgStk=stack(orgFl)
names(orgStk)=c("mintmp","maxtmp","wspd","sph","srad","aod","merra2","ele","xx","yy",
"maot","yaot","laod_mean", "aodl10_gmi","aodl14_gmi","pr")
eleRast=raster(x="/home/lianfal/aodprj/covs_supp/caele.tif")
eleStk=replaceBandImg(orgStk,8,"ele",eleRast)
#Monthly AOD
monthAODFl=paste("/mnt/pmdata/ECHO_PMmodels/caaot/monthaotup/",aimgDf$year,
"/mMonth_",aimgDf$year,"-",ifelse(aimgDf$month<10,"0",""),aimgDf$month,".tif",sep="")
monthaodRst=raster(monthAODFl)
monthaodRst2=resample(monthaodRst,eleStk)
monthaodRst2=mask(monthaodRst2,ca_border)
maodeleStk=replaceBandImg(eleStk,11,"maot",monthaodRst2)
##Yearly AOD
yearlyAODFl=paste("/mnt/pmdata/ECHO_PMmodels/caaot/yearaot/aod",aimgDf$year,".tif",sep="")
yearaodRst=raster(yearlyAODFl)
# plot(monthaodRst)
yearaodRst2=resample(yearaodRst,eleStk)
yearaodRst2=mask(yearaodRst2,ca_border)
ymaodeleStk=replaceBandImg(eleStk,12,"maot",yearaodRst2)
rm(list=c("eleRast","eleStk","monthaodRst","monthaodRst2",
"maodeleStk","yearaodRst","yearaodRst2","orgStk"))
gc()
return(ymaodeleStk)
}
i=5
updateAWeek(i,imgsDf)
tfile=paste("/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/wk",aimgDf$weekid,"aodup",sep="")
writeRaster(ymaodeleStk,tfile,format="GTiff", overwrite=TRUE)
file="/mnt/pmdata2_dup2/LEO/caaot/traindtWkRst_up/imgsDf.rds"
imgsDf=readRDS(file)
imgsDf
nrow(imgsDf)
